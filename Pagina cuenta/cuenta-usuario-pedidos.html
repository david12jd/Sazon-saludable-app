<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: white;
            flex-wrap: wrap;
        }

        .logo img {
            height: 100px;
        }

        .nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav a {
            text-decoration: none;
            color: #a06e4f;
            font-weight: bold;
            font-size: 0.9rem;
            padding: 0.6rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s, transform 0.3s;
        }

        .nav a:hover {
            background-color: rgba(253, 228, 5, 0.379);
            color: #333;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 30px auto;
            gap: 20px;
            flex-wrap: wrap;
            padding: 0 10px;
        }

        .sidebar {
            flex: 1 1 250px;
            background: #debca9;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }

        .profile-pic {
            width: 120px;
            height: 120px;
            background: #fff;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #444;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .profile-pic input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .username {
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
            margin: 20px 0;
        }

        .sidebar button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        .sidebar .infop {
            background: #fff78a;
            font-weight: bold;
        }

        .sidebar .pedidos {
            background: transparent;
            border: 1px solid #fff8a0;
            color: white;
        }

        .main {
            flex: 2 1 600px;
            padding: 20px;
        }

        .idpedido {
            background: #c9ad42;
            padding: 10px;
            text-align: center;
            color: white;
            font-weight: bold;
            border-radius: 10px;
        }

        .pedido {
            border: 1px solid black;
            border-radius: 25px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: white;
        }

        .pedido img {
            width: 30px;
        }

        .historial {
            background: #d8b7a1;
            padding: 10px;
            font-weight: bold;
            margin-top: 20px;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .pedido {
                flex-direction: column;
                text-align: center;
            }
            .nav {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="logo">
        <img src="logo.png" alt="Logo Sazón Saludable">
    </div>
    <nav class="nav">
        <a href="../Pagina log in/index.html">Inicio</a>
        <a href="../Pagina sobre nosotros/sobre_nosotros_historia.html">Sobre nosotros</a>
        <a href="../Pagina carrito/carrito-resumen.html">Carrito</a>
        <a href="../Pagina menu/menu.html">Menú</a>
        <a href="../Pagina contacto/contacto.html">Contacto</a>
        <a href="../Pagina cuenta/cuenta-usuario.html" class="btn-cuenta">Cuenta</a>
        <a href="#" id="cerrarSesionBtn">Cerrar sesión</a>
    </nav>
</header>

<div class="main-content">
    <div class="sidebar">
        <div class="profile-pic">
            FOTO
            <input type="file" accept="image/*">
        </div>
        <div class="username" id="nombreUsuario">Nombre Usuario</div>
        <button class="infop" onclick="window.location.href='cuenta-usuario.html'">Información personal</button>
        <button class="pedidos" onclick="window.location.href='cuenta-usuario-pedidos.html'">Pedido</button>
    </div>

    <div class="main">
        <div id="ultimoPedido" class="idpedido">ID PEDIDO: *****</div>

        <div id="estado1" class="pedido">
            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="icon">
            EN PREPARACION
        </div>
        <div id="estado2" class="pedido">
            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="icon">
            EN CAMINO
        </div>
        <div id="estado3" class="pedido">
            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="icon">
            ENTREGADO
        </div>

        <div class="historial" id="historialPedidos">HISTORIAL PEDIDOS</div>
    </div>
</div>

<!-- Script para autenticación y carga de historial -->
<script>
  const token = localStorage.getItem('token');
  const cliente = JSON.parse(localStorage.getItem('cliente'));

  if (!token || !cliente) {
    window.location.href = '../Pagina log in/log.html';
  } else {
    const cuenta = document.querySelector('.btn-cuenta');
    if (cuenta) {
      cuenta.textContent = `${cliente.nombres} ${cliente.apellidos}`;
    }

    document.getElementById("nombreUsuario").textContent = `${cliente.nombres} ${cliente.apellidos}`;
  }

  // Obtener historial de pedidos del backend
  async function cargarHistorialPedidos() {
    console.log("Token usado:", token);
    try {
      const res = await fetch("http://localhost:3000/api/facturas/mis-pedidos", {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (!res.ok) throw new Error("No se pudo obtener el historial");

      const pedidos = await res.json();
      const historialDiv = document.getElementById("historialPedidos");

      if (pedidos.length === 0) {
        historialDiv.innerHTML = "<p>No tienes pedidos anteriores.</p>";
        return;
      }

      pedidos.forEach(pedido => {
        const fecha = new Date(pedido.fecha_hora).toLocaleDateString();
        const estado = pedido.estado || "Entregado";
        const p = document.createElement("p");
        p.textContent = `ID Pedido: ${pedido.id_factura} - ${fecha} - ${estado}`;
        historialDiv.appendChild(p);
      });

      // Mostrar el último ID pedido
      const ultimo = pedidos[0];
      document.getElementById("ultimoPedido").textContent = `ID PEDIDO: ${ultimo.id_factura}`;

    } catch (error) {
      console.error("Error al cargar pedidos:", error.message);
      document.getElementById("historialPedidos").innerHTML = "<p>Error al cargar el historial.</p>";
    }
  }

  cargarHistorialPedidos();
</script>
<script>
  document.getElementById("cerrarSesionBtn")?.addEventListener("click", function (e) {
    e.preventDefault();
    localStorage.clear(); // Borra token, cliente, carrito, etc.
    window.location.href = "../Pagina principal/index.html";
  });
</script>

</body>
</html>